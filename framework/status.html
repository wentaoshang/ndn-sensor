<html>  
<head>
	<meta charset="utf-8">
	<title>NDN · Routing Status</title>

	<!-- Load styles -->
	<link href="http://fonts.googleapis.com/css?family=Rambla:400,700|Istok+Web:400,700" rel="stylesheet" type="text/css">
	<link rel="stylesheet" type="text/css" href="style.css" />

	<style type="text/css">
		#prefixcontent, #linkcontent, #status, #nosupport { display: none; }
		
		#nosupport h1 {
			font-size: 300%;
		}
	
		#nosupport {
			text-align: center;
			display: none;
		}

		#continue {
			cursor: pointer;
		}
	</style>
</head>

<body>
	<div id="all">
		<div id="top2"></div>
	
		<div id="contentwrapper">
			<div id="header">
				<div id="title">
					<h1>NDN ·</span> <span id="grey">sensor</span> <span id="green">status</span></h1>
				</div>
			</div>

			<div id="status">
				<div id="infodiv">
					<div class="titles"><p>Status information:</p></div>
					<table id="information">
						<thead>
							<tr>
								<td id="grey">Page last updated:</td>
								<td>&nbsp;&nbsp;&nbsp;</td>
								<td><span id="green"><span id="lastupdated">- -</span></span></td>
							</tr>
						</thead>
		
						<tbody>
							<tr>
								<td id="grey">Last logfile processed:</td>
								<td>&nbsp;&nbsp;&nbsp;</td>
								<td><span id="green"><span id="lastlog">- -</span></span></td>
							</tr>
							<tr>
								<td id="grey">Last timestamp in logfile:</td>
								<td>&nbsp;&nbsp;&nbsp;</td>
								<td><span id="green"><span id="lasttimestamp">- -</span></span></td>
							</tr>
						</tbody>
					</table>
				</div>

				<div id="wrap">
					<div class="titles2"><p>Data Summary: </p></div>
					<table id="box-table-a" class="one">
						<thead>
							<tr>
								<th class="border_left" scope="col">Router</th>
								<th scope="col">Timestamp</th>
								<th scope="col">Prefix</th>
								<th class="border_right" scope="col">Status</th>
							</tr>
						</thead>
		
						<tbody id="summary">
						</tbody>
				
						<tfoot><tr><td colspan="4"></td></td></tfoot>
					</table>
				</div>
			</div>
		</div>
		
		<div id="leftcolumn"></div>
		<div id="rightcolumn"></div>
	
		<div id="prefixcontent"></div>
		<div id="linkcontent"></div>

		<div id="base">
			<h3><span id="green">Retrieving</span><span id="grey"> Content</span></h3>
			<img id="loader" src="load.gif" />
			<h3><span id="grey">Powered by</span><span id="green"> NDN.JS</span><span id="grey">.</span></h3>
		</div>

		<div id="nosupport">
			<h1><span id="green">Oops!</span></h1>
			<h3><span id="grey">It looks like you're using a browser that is not <span id="green">supported</span>.</span></h3>
		</div>

	</div>

	<!-- Load scripts at the bottom for efficiency -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script type="text/javascript" src="ndn-js.js"></script>
	<script src="content.js"></script>
	<script src="detect.js"></script>

	<script type="text/javascript">
		var AsyncGetClosure = function AsyncGetClosure() {
			Closure.call(this);
		};

		AsyncGetClosure.prototype.upcall = function(kind, upcallInfo, tmp) {
			if (kind == Closure.UPCALL_FINAL) {
				// Do nothing.
			} else if (kind == Closure.UPCALL_CONTENT) {
				var content = upcallInfo.contentObject;
				var nameStr = content.name.getName();
				
				var json_text = DataUtils.toString(content.content);
				var data = jQuery.parseJSON(json_text);
				
				var output = "<table>";
				output += "<tr><th>Timestamp</th><th>Value</th></tr>";
				for (i = 0; i < data.length; i++) {
					output += "<tr><td>" + data[i].ts + "</td><td>" + data[i].value + "</td></tr>";
				}
				output += "</table>";
				
				document.getElementById("summary").innerHTML = output;
				//document.getElementById("lastlog").innerHTML = obj.lastlog;
				//document.getElementById("lasttimestamp").innerHTML = obj.lasttimestamp;
			} else if (kind == Closure.UPCALL_INTEREST_TIMED_OUT) {
				console.log("Closure.upcall called with interest time out.");
			}
			return Closure.RESULT_OK;
		};

		function getStatus(name) {
			// Template interest to get the latest content.
			var interest = new Interest();
            interest.childSelector = 1;
            interest.interestLifetime = 1000;

            ndn.expressInterest(new Name("/wentao.shang/logtest/" + name), new AsyncGetClosure(), interest);
		}

		// Calls to get the content data.
		function begin() {
			getStatus("data");
		}

		var ndn;
		$(document).ready(function() {
			$("#all").fadeIn(500);
			var res = detect();
	
			if (!res) {
				$("#base").fadeOut(50);	
				$("#nosupport").fadeIn(500);
			} else {
				openHandle = function() { begin() };
				ndn = new NDN({port:9696, host:"localhost", onopen:openHandle});
				ndn.transport.connectWebSocket(ndn);
				$("#base").fadeOut(500, function () {
					$("#status").fadeIn(1000);
				});
		}
		});
	</script>
</body>

</html>

