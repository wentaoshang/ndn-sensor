<!DOCTYPE HTML>
<html>  
<head>
	<meta charset="utf-8">
	<title>NDN Sensor Data</title>

	<!-- Load styles -->
	<link href="http://fonts.googleapis.com/css?family=Rambla:400,700|Istok+Web:400,700" rel="stylesheet" type="text/css">
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<link rel="stylesheet" type="text/css" href="css/envision.min.css" />
</head>

<body>
	<div id="all">
		<header>
			<div id="title">
				<h1>NDN <grey>sensor</grey> <blue>status</blue></h1>
			</div>
		</header>
		
		<article>
			<div id="info">
				<div class="titles"><p>Status Information: </p></div>
				<div id="container">
				</div>
			</div>

			<div id="status">
				<div id="wrap">
					<div class="titles"><p>Summary: </p></div>
<!--
					<table id="box-table-a">
						<thead>
							<tr>
								<th class="border_left" scope="col">Timestamp</th>
								<th scope="col">Blank</th>
								<th class="border_right" scope="col">Value</th>
							</tr>
						</thead>
						
						<tbody id="summary">
						</tbody>
					</table>
-->
				</div>
			</div>
		</article>
	</div>
	
	<footer>
      <grey>Powered by </grey><a target="_blank" href="http://github.com/wentaoshang/ndn-js"><blue>NDN.JS</blue></a><grey>.</grey>
    </footer>

	<!-- Load scripts at the bottom for efficiency -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script type="text/javascript" src="js/ndn-js.js"></script>
	<script type="text/javascript" src="js/content.js"></script>
	<script type="text/javascript" src="js/detect.js"></script>
	<script type="text/javascript" src="js/envision.min.js"></script>

	<script type="text/javascript">
		var AsyncGetClosure = function AsyncGetClosure() {
			Closure.call(this);
		};

		AsyncGetClosure.prototype.upcall = function(kind, upcallInfo, tmp) {
			if (kind == Closure.UPCALL_FINAL) {
				// Do nothing.
			} else if (kind == Closure.UPCALL_CONTENT) {
				var content = upcallInfo.contentObject;
				
				var json_text = DataUtils.toString(content.content);
				var json_obj = jQuery.parseJSON(json_text).data;
				
				var container = document.getElementById('container');
				var x = [], y = [], series_data, options;

				// Data Format:
				series_data = [x, y];
				
				for (i = 0; i < json_obj.length; i++) {
					/*
					if (i % 2 == 1)
						$("#summary").append( '<tr class="odd"><td class="border_left" scope="col">' + json_obj[i].ts 
						+ '</td><td>&nbsp;</td><td class="border_right" scope="col">' + json_obj[i].value + '</td></tr>');
					else
						$("#summary").append( '<tr><td class="border_left" scope="col">' + json_obj[i].ts 
						+ '</td><td>&nbsp;</td><td class="border_right" scope="col">' + json_obj[i].value + '</td></tr>');
					*/
					x.push(i);
					y.push(json_obj[i].value);
				}
				
				
				// TimeSeries Template Options
				options = {
					// Container to render inside of
					container : container,
					// Data for detail (top chart) and summary (bottom chart)
					data : {
						detail : series_data,
						summary : series_data
					},
					// An initial selection
					selection : {
						data : {
							x : {
								min : 1,
								max : 5
							}
						}
					}
				};

				// Create the TimeSeries
				new envision.templates.TimeSeries(options);
				
			} else if (kind == Closure.UPCALL_INTEREST_TIMED_OUT) {
				console.log("Closure.upcall called with interest time out.");
			}
			return Closure.RESULT_OK;
		};

		function getStatus(name) {
			// Template interest to get the latest content.
			var interest = new Interest();
            interest.childSelector = 1;
            interest.interestLifetime = 1000;

            ndn.expressInterest(new Name("/wentao.shang/logtest/" + name), new AsyncGetClosure(), interest);
		}

		// Calls to get the content data.
		function begin() {
			getStatus("data");
		}

		var ndn;
		$(document).ready(function() {
			$("#all").fadeIn(1000);
	
			if (detect()) {
				openHandle = function() { begin() };
				ndn = new NDN({port:9696, host:"localhost", onopen:openHandle});
				ndn.transport.connectWebSocket(ndn);
			}
		});
	</script>
</body>

</html>

